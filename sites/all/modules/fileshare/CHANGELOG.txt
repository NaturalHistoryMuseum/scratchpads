// $Id$

/**
 * Incorporated bRiha's changes to port to Drupal 5, 01/23/2007
 */
 
/**
 * Jamie Ruderman, 10/26/2006
 * 
 * Added the following functionality:
 * 
 * 1) Download method control per node - Private or Public
 * 2) Node file path management per node - You may now spec a file path from the 
 *    root of your webserver outside of the drupal directory, however upload and
 *    delete functionality will not work and should be disabled. Also you must set
 *    the download method to private. This could be used for extra secuity in a 
 *   downloads only area that is managed by other means.
 * 3) File extension whitelist per node - no more dependancy on upload.module
 * 
 * This update also adds the following new columns:
 *   _basepath
 *   _method
 *   _whitelist
 * 
 * You must run the update script to update your database. After that old fileshares 
 * should need no new updating and should continue to work as is.
 * 
 * I also revised the download functions slightly to work without dependancy on the 
 * system file path and to use the nid instead.
 */ 
 
/**
 * Patrick Donohue, 11/09/2006
 * I took two patches off of http://jamieruderman.com/ neither of which seemed
 * to work on their own and kludged them together with version 1.2.2.1 of
 * fileshare module.  These two patches were intended to handle access
 * restrictions for private drupal file systems and for organic groups. Both
 * had some difficulties and given my lack of drupal knowledge I'm probably
 * doing lots of redundant things here.
 *
 * 1) For FiNeX's patch you need to add a TinyINT(1) field to the 
 * node_fileshare table in your database, the field is named "_private"
 * 2) FiNeX's patch also appeared to be incorrectly returning TRUE instead of
 * NULL in fileshare_access when the private field for the fileshare was not
 * set (which resulted in any user being able to view the fileshare regardless
 * of other access restrictions supplied by organic groups etc.)
 * 3) FiNeX's patch also seems to get around the problem that the default
 * drupal file_download function for private file systems doesn't allow the 
 * user to download a file that doesn't exist in the 'files' table
 * 4) Jonathan_Hunt's patch provided mime encoding read from the file system
 * 5) Hunt's patch also provided an access check for an individual file 
 * against its parent fileshare... at least that's what I think, like I said, 
 * I'm not great with the drupal coding.
 * 6) FiNeX's patch works against 1.2.2.1 Hunt's appears to be badly malformed
 * so I just cut, pasted and modified his.
 * 7) I added the small changes Jamie made between 1.2.2.1 to 1.2.2.2, but 
 * this version is therefore still missing the AJAX and JAH fixes Jamie 
 * made in 1.2.2.3 and 1.2.3.4
 *
 * Any ways, probably got redudant stuff, but this appears to give me the 
 * access handling I wanted with organic groups and a private file system.  
 */

/**
 * FiNeX, 24/07/2006
 * 1) Added the _fileshare_download() for override the default download function:
 * if the private download method is selected, the drupal file_donwload() function doesn't let
 * let the user to download a file that doesn't exist in the 'files' table.
 * 2) Added some new access permissions:
 *    - 'download own files' : it's needed for let the download of the files only to the node owner
 *    - 'modify own files' : same, but it's used for allow the editing only to the node owner
 * 3) Added a new check option on the node: 'Set the node private'. With this new option, the node is 
 *    viewable only for the node owner. If the download method is set to private (and the .htaccess is right)
 *    the file are really secure... I hope :-)
 *    Before if an user wrote the right address of a files (with ?q=system/files....), he could download it.
 */