<?php

/**
 * @file 
 * 
 * This is the Mado module file.  It does very little but load the include for
 * the alternative taxonomy/term/[x] pages.
 */

/**
 * Implementation of hook_menu
 */
function mado_menu(){  
  $items = array();  
  $items['taxonomy/term/%'] = array(
    'title' => 'Taxonomy term',
    'page callback' => 'mado_term_page',
    'page arguments' => array(2),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'mado.pages.inc',
  );
  $items['mado/save'] = array(
    'title' => '',
    'page callback' => 'mado_save_layout',
    'access arguments' => array('layout mado'),
    'type' => MENU_CALLBACK
  );  
  return $items;
}

function mado_perm(){
}
/**
 * Implementation of hook_theme()
 */
function mado_theme() {
  return array(
    'mado_block' => array(
      'arguments' => array('block' => array()),
    )
  );
}

/**
 * Returns an array of all the possible blocks a page can have
 *
 */
function mado_get_blocks(){
  $blocks_and_views = array();
  $views = views_get_all_views();
  $i = 0;
  foreach($views as $view){
    if($view->display['default']->display_options['arguments']['tid']){
      $blocks_and_views['view-'.$i] = array(
        '#type' => 'view',
        '#name' => $view->name,
        '#scroll' => TRUE,
        '#css' => 'mado_block_2'
      );
      $i++;
    }
  }
  $i = 0;
  foreach(module_implements('block') as $module){
    $blocks = call_user_func($module.'_block','list');
    foreach($blocks as $id => $block){
      $blocks_and_views['block-'.$i] = array(
        '#type' => 'block',
        '#name' => "$module/$id",
        '#scroll' => TRUE,
        '#css' => 'mado_block_2'
      );
      $i++;
    }
  }
  $blocks_and_views['divider'] = array(
    '#type' => 'divider'
  );
  return $blocks_and_views;
}

/**
 * Save the theme - ajax callback
 */
function mado_save_layout(){
  $blocks = array();
  $all_blocks = mado_get_blocks();
  foreach($_GET['blocks'] as $block){
    $blocks[$block] = $all_blocks[$block];
    if($block == 'divider'){
      break;
    }
  }
  db_query("DELETE FROM {mado} WHERE identifier = '%s'", $_GET['identifier']);
  db_query("INSERT INTO {mado} (identifier, blocks) VALUES ('%s', '%s')", $_GET['identifier'], serialize($blocks));
}

/**
 * Get the theme that this vocabulary is set to use.  Returns false if this 
 * vocabulary should use the standard layout.
 */
function mado_get_theme($vid, $tid = false){
  // FIXME - Change the following:
  if($vid!=6){return false;}
  
  // try and get the blocks
  $blocks = db_fetch_array(db_query("SELECT blocks FROM {mado} WHERE identifier = '%s' OR identifier = '%s' ORDER BY identifier DESC", $vid, "$vid/$tid"));
  if($blocks){
    return unserialize(array_pop($blocks));
  } else {
    return mado_get_blocks();
  }
  return false;
}