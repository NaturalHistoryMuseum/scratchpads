<?php

// We need a single settings page to edit the defaults, and then a function
// which can be executed manually, or on cron to apply these defaults.

function fixperms_menu(){
  $menu = array();
  $menu['admin/settings/fixperms'] = array(
    'title' => 'Fixperms settings',
    'description' => 'Change the default fixperms settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('fixperms_admin_settings'),
    'access arguments' => array('administer site configuration')  
  );
  return $menu;
}

/**
 * Implementation of hook_perm
 */
function fixperms_perm(){
  return array('create type content','edit own type content','edit any type content','delete own type content','delete any type content');
}

/**
 * Implementation of hook_form_alter
 */
function fixperms_form_alter(&$form, $form_state, $form_id){
  if($form_id != 'user_admin_perm'){
    return;
  }
  $form['#submit'][] = 'fixperms_submit';
}
/**
 * Fix the perms on cron.
 */
function fixperms_cron(){
  fixperms_submit();
}

/**
 * Receive the form, and update the perms
 */
function fixperms_submit(){
  $current_permissions = array();
  $result = db_query("SELECT rid, perm FROM {permission}");
  while($row = db_fetch_array($result)){
    $current_permissions[$row['rid']] = $row['perm'].", ";
  }
  $content_types = array_keys(content_types());
  $perms = fixperms_perm();
  foreach($current_permissions as $rid => $permission){
    foreach($perms as $perm){
      // If the perm is in the current_permission, then we need to set all the
      // content type permissions, else we need to remove them.
      if(strpos($permission,$perm) === FALSE){
        // The string isn't in there, we need to remove all the content type 
        foreach($content_types as $type){
          $type = str_replace("type", $type, $perm).", ";
          $permission = str_replace($type, "", $permission);
        }
      } else {
        // String is in there, lets add all the content type values 
        foreach($content_types as $type){
          $type = str_replace("type", $type, $perm).", ";
          // First remove
          $permission = str_replace($type, "", $permission);
          // Then add
          $permission .= $type;
        }
      }
    }
    // Save the permission
    db_query("UPDATE {permission} SET perm = '%s' WHERE rid = %d", substr($permission,0,-2), $rid);
  }
}