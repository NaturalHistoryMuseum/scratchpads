<?php

define('PENSOFT_EMAIL_ADDRESS', 'ben@benscott.co.uk');

/**
 * Implementation of hook_export_publication().
 */
function pensoft_publication_info() {  
  return array(
    'name' => 'Pensoft',
    'description' => 'Export to the Sofia based publisher of ZooKeys and PhytoKeys'
  );  
}

function pensoft_form_publication_export_form_alter($form, $form_state, $form_id){
  if(isset($form_state['post']['module']) && $form_state['post']['module'] == 'pensoft'){
    if(isset($form['#validate'])){
      $form['#validate'][] = 'pensoft_publication_export_form_validate';
    } else {
      $form['#validate'] = array('pensoft_publication_export_form_validate');
    }
    $form['pensoft'] = array(
      'vat_number' => array(
        '#type' => 'textfield',
        '#title' => t('VAT number'),
        '#required' => TRUE,
        '#description' => '('.t('If present, for EU customers only.').')',
      ),
      'notes' => array(
        '#type' => 'textarea',
        '#title' => t('Your notes'),
      )
    );
  }
}

function pensoft_publication_export_form_validate($form, &$form_state){
  if(!is_numeric($form_state['values']['vat_number'])){
    form_set_error('vat_number', t('Must be numeric'));
  }
}

function pensoft_publication_export_form_submit($form, &$form_state){
  
  global $user;
  
  if($filepath = publication_create_xml_file($form['#node'])){
    
    $destinations = array(PENSOFT_EMAIL_ADDRESS);
    $message = new stdClass;
    $message->subject = 'test';
    $message->body = 'The XML can be downloaded from: ' . url($filepath, array('absolute' => true));
    $message->sender_account = $user;
    
    if(messaging_message_send($destinations, $message, 'mail')){

    	drupal_set_message(t('The XML file has been sent to Pensoft.'));
    	
    }else{
    	
    	drupal_set_message(t('The XML file could not be emailed.'), 'error');
    	
    }
    
   
  }else{
    
    drupal_set_message(t('The XML file could not be created at this time.'), 'error');
    
  }
	
}